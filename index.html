<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>å›¾å®‰å·¥ä½œçŸ¥è¯†åº“</title>
  <style>
    body{margin:0;font-family:system-ui;background:#0b1020;color:#eaf0ff}
    .wrap{max-width:1550px;margin:0 auto;padding:14px}
    .muted{color:#9cb0df;font-size:12px}
    .grid{display:grid;grid-template-columns:260px 1.2fr 1fr;gap:12px}
    .card{background:#111a33;border:1px solid #2a3c6b;border-radius:10px;padding:10px}
    h3{margin:0 0 8px 0}
    .item{padding:8px;border-radius:8px;cursor:pointer}
    .item:hover{background:#172447}
    .active{background:#1d2f5c}
    table{width:100%;border-collapse:collapse;font-size:12px}
    td,th{padding:6px;border-bottom:1px solid #25345e;text-align:left;vertical-align:top}
    input{background:#0c1428;border:1px solid #2a3c6b;color:#eaf0ff;border-radius:8px;padding:8px}
    .scroll{max-height:70vh; overflow:auto; border:1px solid #22365f; border-radius:8px}
    .btn{display:inline-block;padding:6px 10px;border:1px solid #2a3c6b;border-radius:8px;color:#d9e6ff;text-decoration:none;margin-right:6px;background:#0c1428}
    .btn:hover{background:#162548}
    .tag{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid #2a3c6b;margin:0 6px 6px 0;cursor:pointer;font-size:12px}
    .tag.on{background:#1b2f58}
    code{background:#0c1428;padding:2px 6px;border-radius:6px;border:1px solid #2a3c6b}
    .thumb{display:flex;align-items:center;justify-content:center;width:92px;height:120px;border:1px solid #2a3c6b;border-radius:8px;background:#0b1328;margin-bottom:8px;font-size:38px}
  </style>
</head>
<body>
<div class="wrap">
  <h2>å›¾å®‰å·¥ä½œçŸ¥è¯†åº“ç½‘ç«™ï¼ˆä¸‰çº§é¡µé¢ï¼‰</h2>
  <div class="muted" id="meta">åŠ è½½ä¸­...</div>
  <div style="display:flex;gap:8px;margin:10px 0">
    <input id="q" placeholder="æœç´¢é¡¹ç›®å/æ–‡ä»¶å/æ ‡ç­¾" style="flex:1"/>
  </div>

  <div class="card" style="margin-bottom:10px">
    <h3>æ ‡ç­¾ç­›é€‰</h3>
    <div id="primaryTags"></div>
    <div id="secondaryTags" class="muted" style="margin-top:4px"></div>
  </div>

  <div class="grid">
    <div class="card"><h3>ä¸€çº§ç›®å½•</h3><div id="cats"></div></div>
    <div class="card"><h3>äºŒçº§ç›®å½•ï¼ˆç´¢å¼•ï¼ŒæŒ‰é¡¹ç›®åˆå¹¶ï¼‰</h3><div id="list" class="scroll"></div></div>
    <div class="card"><h3>ä¸‰çº§é¡µé¢ï¼ˆè¯¦æƒ…ï¼‰</h3><div id="detail" class="muted">è¯·é€‰æ‹©é¡¹ç›®</div></div>
  </div>
</div>
<script>
let KB=null, currentCat='', currentProjects=[];
let selectedPrimary='', selectedSecondary='';

const esc=s=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
const pick=(obj,k,d='-')=>(obj&&obj[k]!=null&&obj[k]!==''?obj[k]:d);

function extIcon(ext=''){
  const e=String(ext||'').toLowerCase();
  if(['.pdf'].includes(e)) return 'ğŸ“•';
  if(['.doc','.docx'].includes(e)) return 'ğŸ“˜';
  if(['.xls','.xlsx'].includes(e)) return 'ğŸ“—';
  if(['.ppt','.pptx'].includes(e)) return 'ğŸ“™';
  if(['.mp4','.mov','.avi','.mkv','.wmv','.flv'].includes(e)) return 'ğŸ¬';
  return 'ğŸ“„';
}

function renderCats(){
  const box=document.getElementById('cats');
  box.innerHTML=KB.categories.map(c=>`<div class='item ${currentCat===c.name?'active':''}' onclick="pickCat('${c.name}')">${esc(c.name)} (${c.count})</div>`).join('');
}

function renderTagFilters(){
  const pBox=document.getElementById('primaryTags');
  const sBox=document.getElementById('secondaryTags');
  const tree=KB.tag_tree||{};
  const pKeys=Object.keys(tree);

  pBox.innerHTML = [`<span class='tag ${selectedPrimary===''?'on':''}' onclick="setPrimary('')">å…¨éƒ¨è¡Œä¸š</span>`]
    .concat(pKeys.map(p=>`<span class='tag ${selectedPrimary===p?'on':''}' onclick="setPrimary('${p}')">${esc(p)}</span>`)).join('');

  if(!selectedPrimary || !tree[selectedPrimary] || !tree[selectedPrimary].length){
    sBox.innerHTML='';
    selectedSecondary='';
    return;
  }

  const second=tree[selectedPrimary];
  sBox.innerHTML = [`<span class='tag ${selectedSecondary===''?'on':''}' onclick="setSecondary('')">å…¨éƒ¨äºŒçº§</span>`]
    .concat(second.map(s=>`<span class='tag ${selectedSecondary===s?'on':''}' onclick="setSecondary('${s}')">${esc(s)}</span>`)).join('');
}

function setPrimary(p){ selectedPrimary=p; selectedSecondary=''; renderTagFilters(); renderList(); }
function setSecondary(s){ selectedSecondary=s; renderTagFilters(); renderList(); }

function filt(d){
  const q=document.getElementById('q').value.trim().toLowerCase();
  if(selectedPrimary && d.industry_primary!==selectedPrimary) return false;
  if(selectedSecondary && d.industry_secondary!==selectedSecondary) return false;
  if(!q) return true;
  return JSON.stringify(d).toLowerCase().includes(q);
}

function mergeByProject(rows){
  const m=new Map();
  rows.forEach(d=>{
    const k=(d.project_name||'æœªå‘½åé¡¹ç›®').trim();
    if(!m.has(k)){
      m.set(k,{project_name:k, files:[], latest_updated_at:'', industry_primary:d.industry_primary||'å…¶ä»–è¡Œä¸š', industry_secondary:d.industry_secondary||'', time:d.time||'', presale_name:d.presale_name||''});
    }
    const g=m.get(k);
    g.files.push(d);
    if(!g.latest_updated_at || String(d.updated_at)>String(g.latest_updated_at)) g.latest_updated_at=d.updated_at;
    if((g.industry_primary==='å…¶ä»–è¡Œä¸š' || !g.industry_primary) && d.industry_primary) g.industry_primary=d.industry_primary;
    if(!g.industry_secondary && d.industry_secondary) g.industry_secondary=d.industry_secondary;
    if(String(d.time)>String(g.time)) g.time=d.time;
  });
  return Array.from(m.values()).sort((a,b)=>String(b.latest_updated_at).localeCompare(String(a.latest_updated_at)));
}

function renderList(){
  const rows=(KB.by_category[currentCat]||[]).filter(filt);
  const projects=mergeByProject(rows);
  currentProjects=projects;
  const box=document.getElementById('list');
  box.innerHTML = `<table><thead><tr><th>é¡¹ç›®åç§°</th><th>æ ‡ç­¾</th><th>æœ€æ–°æ›´æ–°æ—¶é—´</th><th>æ–‡ä»¶æ•°</th></tr></thead><tbody>`+
    projects.map((p,i)=>`<tr class='item' onclick='showProject(${i})'><td>${esc(p.project_name)}</td><td>${esc(p.industry_primary||'å…¶ä»–è¡Œä¸š')}${p.industry_secondary?` / ${esc(p.industry_secondary)}`:''}</td><td>${esc(p.latest_updated_at)}</td><td>${p.files.length}</td></tr>`).join('')+
    `</tbody></table>`;
}

function showProject(i){
  const p=currentProjects[i]; if(!p) return;
  const files=(p.files||[]).sort((a,b)=>String(b.updated_at).localeCompare(String(a.updated_at)));
  const rows=files.map(f=>`<tr>
    <td>
      <div class='thumb'>${extIcon(f.ext)}</div>
      <div>${esc(f.title)}</div>
    </td>
    <td>${esc(pick(f,'industry_primary','å…¶ä»–è¡Œä¸š'))}${f.industry_secondary?` / ${esc(f.industry_secondary)}`:''}</td>
    <td>${esc(pick(f,'updated_at'))}</td>
    <td>
      <a class='btn' href='/preview?path=${encodeURIComponent(f.file_path)}' target='_blank'>é¢„è§ˆ</a>
      <a class='btn' href='/download?path=${encodeURIComponent(f.file_path)}'>ä¸‹è½½</a>
    </td>
  </tr>`).join('');

  document.getElementById('detail').innerHTML = `
    <div><b>é¡¹ç›®åç§°ï¼š</b>${esc(p.project_name)}</div>
    <div><b>æ ‡ç­¾ï¼š</b>${esc(p.industry_primary||'å…¶ä»–è¡Œä¸š')}${p.industry_secondary?` / ${esc(p.industry_secondary)}`:''}</div>
    <div><b>æ—¶é—´ï¼š</b>${esc(p.time||'-')}</div>
    <div><b>å”®å‰å§“åï¼š</b>${esc(p.presale_name||'-')}</div>
    <div><b>æœ€æ–°æ›´æ–°æ—¶é—´ï¼š</b>${esc(p.latest_updated_at||'-')}</div>
    <div style='margin:8px 0'><b>æ–‡ä»¶æ¸…å•ï¼ˆåˆå¹¶åŒé¡¹ç›®ï¼‰</b></div>
    <div class='scroll'><table><thead><tr><th>æ–‡æ¡£ç¼©ç•¥å›¾/æ–‡ä»¶å</th><th>æ ‡ç­¾</th><th>æ›´æ–°æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>${rows||'<tr><td colspan="4">æ— </td></tr>'}</tbody></table></div>
  `;
}

function pickCat(c){ currentCat=c; renderCats(); renderList(); document.getElementById('detail').innerHTML='è¯·é€‰æ‹©é¡¹ç›®'; }

async function boot(){
  KB = await (await fetch('./data/kb.json')).json();
  document.getElementById('meta').textContent=`æ ¹ç›®å½•ï¼š${KB.root} | åŸå§‹æ–‡ä»¶ ${KB.total_raw_files} | å»é‡å ${KB.total_indexed_latest} | ç”Ÿæˆæ—¶é—´ ${KB.generated_at}`;
  currentCat=(KB.categories[0]||{}).name||'';
  renderCats(); renderTagFilters(); renderList();
  document.getElementById('q').addEventListener('input', renderList);
}
boot();
</script>
</body>
</html>
